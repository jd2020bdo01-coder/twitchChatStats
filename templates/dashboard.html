<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat Analytics Dashboard</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			:root {
				--primary-color: #667eea;
				--secondary-color: #764ba2;
				--accent-color: #4caf50;
				--danger-color: #f44336;
				--warning-color: #ff9800;
				--background-dark: #0f0f0f;
				--surface-dark: #1a1a1a;
				--surface-light: #2a2a2a;
				--surface-hover: #3a3a3a;
				--text-primary: #ffffff;
				--text-secondary: #cccccc;
				--text-muted: #888888;
				--border-color: #444444;
				--shadow-light: 0 2px 8px rgba(0, 0, 0, 0.15);
				--shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.25);
				--shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.35);
				--border-radius: 12px;
				--border-radius-small: 8px;
				--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, sans-serif;
				background: linear-gradient(
					135deg,
					var(--background-dark) 0%,
					#161616 100%
				);
				color: var(--text-primary);
				line-height: 1.6;
				min-height: 100vh;
			}

			.app-header {
				background: linear-gradient(
					135deg,
					var(--primary-color) 0%,
					var(--secondary-color) 100%
				);
				padding: 1.5rem 2rem;
				box-shadow: var(--shadow-medium);
				position: sticky;
				top: 0;
				z-index: 100;
				backdrop-filter: blur(10px);
			}

			.app-header h1 {
				font-size: 2.5rem;
				font-weight: 700;
				letter-spacing: -0.025em;
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.app-header h1 i {
				font-size: 2rem;
			}

			.status-bar {
				background: var(--surface-light);
				padding: 1rem 2rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
				backdrop-filter: blur(10px);
			}

			.status-indicator {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				font-weight: 500;
			}

			.status-dot {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				background: var(--accent-color);
				box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
				animation: pulse 2s infinite;
			}

			.status-dot.disconnected {
				background: var(--danger-color);
				box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
			}

			@keyframes pulse {
				0%,
				100% {
					transform: scale(1);
				}
				50% {
					transform: scale(1.1);
				}
			}

			.container {
				padding: 2rem;
				max-width: 1600px;
				margin: 0 auto;
			}

			.controls-panel {
				background: var(--surface-light);
				padding: 2rem;
				border-radius: var(--border-radius);
				margin-bottom: 2rem;
				box-shadow: var(--shadow-light);
				border: 1px solid var(--border-color);
			}

			.controls-header {
				display: flex;
				align-items: center;
				gap: 1rem;
				margin-bottom: 1.5rem;
			}

			.controls-header h3 {
				font-size: 1.25rem;
				font-weight: 600;
				color: var(--text-primary);
			}

			.controls-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 1.5rem;
				align-items: end;
			}

			.form-group {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}

			.form-group label {
				font-weight: 500;
				color: var(--text-secondary);
				font-size: 0.875rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			.modern-input,
			.modern-select,
			.modern-button {
				padding: 0.75rem 1rem;
				border: 2px solid var(--border-color);
				border-radius: var(--border-radius-small);
				background: var(--surface-dark);
				color: var(--text-primary);
				font-size: 0.925rem;
				font-weight: 500;
				transition: var(--transition);
				outline: none;
			}

			.modern-input:focus,
			.modern-select:focus {
				border-color: var(--primary-color);
				box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
			}

			.modern-button {
				background: linear-gradient(
					135deg,
					var(--primary-color) 0%,
					var(--secondary-color) 100%
				);
				border: 2px solid transparent;
				cursor: pointer;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				display: flex;
				align-items: center;
				gap: 0.5rem;
				justify-content: center;
				min-height: 48px;
			}

			.modern-button:hover {
				transform: translateY(-2px);
				box-shadow: var(--shadow-medium);
			}

			.modern-button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
				transform: none;
			}

			.modern-button.secondary {
				background: transparent;
				border-color: var(--border-color);
				color: var(--text-secondary);
			}

			.modern-button.secondary:hover {
				background: var(--surface-hover);
				border-color: var(--primary-color);
				color: var(--text-primary);
			}

			.date-picker-container {
				position: relative;
			}

			.date-suggestions {
				position: absolute;
				top: 100%;
				left: 0;
				right: 0;
				background: var(--surface-light);
				border: 2px solid var(--border-color);
				border-radius: var(--border-radius-small);
				box-shadow: var(--shadow-medium);
				z-index: 50;
				max-height: 200px;
				overflow-y: auto;
				display: none;
			}

			.date-suggestion {
				padding: 0.75rem 1rem;
				cursor: pointer;
				border-bottom: 1px solid var(--border-color);
				transition: var(--transition);
			}

			.date-suggestion:hover {
				background: var(--surface-hover);
			}

			.date-suggestion:last-child {
				border-bottom: none;
			}

			.channels-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
				gap: 1.5rem;
				margin-bottom: 2rem;
			}

			.channel-card {
				background: var(--surface-light);
				border-radius: var(--border-radius);
				padding: 1.5rem;
				border: 2px solid var(--border-color);
				cursor: pointer;
				transition: var(--transition);
				position: relative;
				overflow: hidden;
			}

			.channel-card::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 4px;
				background: linear-gradient(
					90deg,
					var(--primary-color),
					var(--secondary-color)
				);
				transform: scaleX(0);
				transition: var(--transition);
			}

			.channel-card:hover {
				transform: translateY(-4px);
				box-shadow: var(--shadow-medium);
				border-color: var(--primary-color);
			}

			.channel-card:hover::before {
				transform: scaleX(1);
			}

			.channel-card.selected {
				border-color: var(--primary-color);
				box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
			}

			.channel-card.selected::before {
				transform: scaleX(1);
			}

			.channel-header {
				display: flex;
				align-items: center;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.channel-icon {
				width: 48px;
				height: 48px;
				background: linear-gradient(
					135deg,
					var(--primary-color),
					var(--secondary-color)
				);
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.25rem;
				font-weight: 600;
				color: white;
			}

			.channel-name {
				font-size: 1.375rem;
				font-weight: 700;
				color: var(--text-primary);
			}

			.channel-stats {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
			}

			.stat-item {
				text-align: center;
				padding: 0.75rem;
				background: var(--surface-dark);
				border-radius: var(--border-radius-small);
			}

			.stat-value {
				font-size: 1.5rem;
				font-weight: 700;
				color: var(--primary-color);
				display: block;
			}

			.stat-label {
				font-size: 0.875rem;
				color: var(--text-muted);
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			.data-section {
				background: var(--surface-light);
				border-radius: var(--border-radius);
				padding: 2rem;
				box-shadow: var(--shadow-light);
				border: 1px solid var(--border-color);
			}

			.section-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 2rem;
				gap: 2rem;
			}

			.section-title h2 {
				font-size: 1.75rem;
				font-weight: 700;
				margin-bottom: 1rem;
				color: var(--text-primary);
			}

			.summary-cards {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 1rem;
			}

			.summary-card {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				text-align: center;
				border: 1px solid var(--border-color);
			}

			.table-controls {
				display: flex;
				gap: 1rem;
				align-items: center;
			}

			.search-container {
				position: relative;
				display: flex;
				align-items: center;
			}

			.search-container i {
				position: absolute;
				left: 1rem;
				color: var(--text-muted);
				z-index: 10;
			}

			.search-container input {
				padding-left: 2.5rem;
				min-width: 250px;
			}

			.table-container {
				background: var(--surface-dark);
				border-radius: var(--border-radius-small);
				overflow: hidden;
				border: 1px solid var(--border-color);
			}

			.loading-state {
				text-align: center;
				padding: 3rem;
				color: var(--text-muted);
			}

			.spinner {
				width: 40px;
				height: 40px;
				border: 3px solid var(--border-color);
				border-top: 3px solid var(--primary-color);
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin: 0 auto 1rem;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.modern-table {
				width: 100%;
				border-collapse: collapse;
			}

			.modern-table th,
			.modern-table td {
				padding: 1rem;
				text-align: left;
				border-bottom: 1px solid var(--border-color);
			}

			.modern-table th {
				background: var(--surface-hover);
				font-weight: 600;
				color: var(--text-primary);
				cursor: pointer;
				transition: var(--transition);
				user-select: none;
			}

			.modern-table th:hover {
				background: var(--primary-color);
				color: white;
			}

			.modern-table th i {
				margin-right: 0.5rem;
			}

			.modern-table tbody tr {
				transition: var(--transition);
			}

			.modern-table tbody tr:hover {
				background: var(--surface-hover);
			}

			.alt-badge {
				display: inline-block;
				padding: 0.25rem 0.75rem;
				border-radius: 20px;
				font-size: 0.875rem;
				font-weight: 600;
				text-align: center;
				min-width: 60px;
			}

			.alt-badge.low {
				background: rgba(76, 175, 80, 0.2);
				color: var(--accent-color);
				border: 1px solid var(--accent-color);
			}

			.alt-badge.medium {
				background: rgba(255, 152, 0, 0.2);
				color: var(--warning-color);
				border: 1px solid var(--warning-color);
			}

			.alt-badge.high {
				background: rgba(244, 67, 54, 0.2);
				color: var(--danger-color);
				border: 1px solid var(--danger-color);
			}

			.similar-users-list {
				max-width: 300px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				color: var(--text-secondary);
				font-size: 0.875rem;
			}

			.notification {
				position: fixed;
				top: 20px;
				right: 20px;
				padding: 1rem 1.5rem;
				border-radius: var(--border-radius-small);
				color: white;
				font-weight: 500;
				z-index: 1000;
				transform: translateX(400px);
				transition: var(--transition);
			}

			.notification.show {
				transform: translateX(0);
			}

			.notification.success {
				background: var(--accent-color);
			}

			.notification.error {
				background: var(--danger-color);
			}

			@media (max-width: 768px) {
				.container {
					padding: 1rem;
				}

				.controls-grid {
					grid-template-columns: 1fr;
				}

				.section-header {
					flex-direction: column;
					align-items: stretch;
				}

				.table-controls {
					flex-direction: column;
					align-items: stretch;
				}

				.search-container input {
					min-width: 100%;
				}

				.channels-grid {
					grid-template-columns: 1fr;
				}
			}
			#dataTableSection .section-title {
				width: 100%;
			}

			/* Enhanced Date Filter Styles */
			.selected-dates-container {
				margin-top: 1rem;
				padding: 1rem;
				background: var(--surface-dark);
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
			}

			.selected-dates-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.75rem;
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.clear-dates-btn {
				background: var(--danger-color);
				color: white;
				border: none;
				padding: 0.25rem 0.5rem;
				border-radius: var(--border-radius-small);
				font-size: 0.75rem;
				cursor: pointer;
				transition: var(--transition);
			}

			.clear-dates-btn:hover {
				background: #d32f2f;
			}

			.selected-dates-list {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}

			.selected-date-chip {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.375rem 0.75rem;
				background: var(--primary-color);
				color: white;
				border-radius: 20px;
				font-size: 0.875rem;
				font-weight: 500;
			}

			.selected-date-chip.exclude-mode {
				background: var(--danger-color);
			}

			.selected-date-chip .remove-btn {
				background: none;
				border: none;
				color: white;
				cursor: pointer;
				padding: 0;
				width: 16px;
				height: 16px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				transition: var(--transition);
			}

			.selected-date-chip .remove-btn:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			.date-suggestions {
				position: absolute;
				top: 100%;
				left: 0;
				right: 0;
				background: var(--surface-light);
				border: 1px solid var(--border-color);
				border-radius: var(--border-radius-small);
				max-height: 200px;
				overflow-y: auto;
				z-index: 1000;
				box-shadow: var(--shadow-medium);
				margin-top: 2px;
			}

			.date-suggestion-item {
				padding: 0.75rem 1rem;
				cursor: pointer;
				border-bottom: 1px solid var(--border-color);
				transition: var(--transition);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.date-suggestion-item:last-child {
				border-bottom: none;
			}

			.date-suggestion-item:hover {
				background: var(--surface-hover);
			}

			.date-suggestion-item.selected {
				background: var(--primary-color);
				color: white;
			}

			.date-suggestion-item.excluded {
				background: var(--danger-color);
				color: white;
			}

			.date-picker-container {
				position: relative;
			}

			.filter-mode-help {
				font-size: 0.8rem;
				color: var(--text-muted);
				margin-top: 0.5rem;
				padding: 0.5rem;
				background: var(--surface-dark);
				border-radius: var(--border-radius-small);
				border-left: 3px solid var(--primary-color);
			}

			/* User Detail Popup Styles */
			.user-detail-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				z-index: 10000;
				display: none;
				align-items: center;
				justify-content: center;
				backdrop-filter: blur(4px);
			}

			.user-detail-popup {
				background: var(--surface-light);
				border-radius: var(--border-radius);
				width: 90%;
				max-width: 900px;
				max-height: 90vh;
				overflow: hidden;
				box-shadow: var(--shadow-heavy);
				border: 1px solid var(--border-color);
				display: flex;
				flex-direction: column;
			}

			.user-detail-header {
				padding: 1.5rem 2rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
				background: linear-gradient(
					135deg,
					var(--primary-color),
					var(--secondary-color)
				);
				color: white;
			}

			.user-detail-title {
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.user-avatar {
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background: rgba(255, 255, 255, 0.2);
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 1.5rem;
				font-weight: bold;
			}

			.user-detail-close {
				background: none;
				border: none;
				color: white;
				font-size: 1.5rem;
				cursor: pointer;
				padding: 0.5rem;
				border-radius: 50%;
				transition: var(--transition);
			}

			.user-detail-close:hover {
				background: rgba(255, 255, 255, 0.2);
			}

			.user-detail-content {
				flex: 1;
				overflow-y: auto;
				padding: 0;
			}

			.user-detail-tabs {
				display: flex;
				border-bottom: 1px solid var(--border-color);
				background: var(--surface-dark);
			}

			.user-detail-tab {
				padding: 1rem 1.5rem;
				background: none;
				border: none;
				color: var(--text-secondary);
				cursor: pointer;
				transition: var(--transition);
				font-weight: 500;
			}

			.user-detail-tab.active {
				color: var(--primary-color);
				border-bottom: 2px solid var(--primary-color);
				background: var(--surface-light);
			}

			.user-detail-tab:hover:not(.active) {
				color: var(--text-primary);
				background: var(--surface-hover);
			}

			.user-detail-tab-content {
				display: none;
				padding: 1.5rem;
			}

			.user-detail-tab-content.active {
				display: block;
			}

			.user-stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1rem;
				margin-bottom: 2rem;
			}

			.user-stat-card {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				text-align: center;
			}

			.user-stat-value {
				font-size: 1.5rem;
				font-weight: bold;
				color: var(--primary-color);
				display: block;
			}

			.user-stat-label {
				font-size: 0.875rem;
				color: var(--text-muted);
				margin-top: 0.25rem;
			}

			.user-messages-list {
				max-height: 400px;
				overflow-y: auto;
				border: 1px solid var(--border-color);
				border-radius: var(--border-radius-small);
			}

			.user-message-item {
				padding: 1rem;
				border-bottom: 1px solid var(--border-color);
				transition: var(--transition);
			}

			.user-message-item:last-child {
				border-bottom: none;
			}

			.user-message-item:hover {
				background: var(--surface-hover);
			}

			.user-message-meta {
				display: flex;
				justify-content: between;
				align-items: center;
				margin-bottom: 0.5rem;
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.user-message-date {
				font-weight: 500;
			}

			.user-message-time {
				margin-left: auto;
			}

			.user-message-text {
				color: var(--text-primary);
				line-height: 1.4;
				word-wrap: break-word;
			}

			.user-channels-list {
				display: grid;
				gap: 1rem;
			}

			.user-channel-item {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.user-channel-name {
				font-weight: 600;
				color: var(--primary-color);
			}

			.user-channel-stats {
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.user-activity-timeline {
				display: grid;
				gap: 0.5rem;
				max-height: 400px;
				overflow-y: auto;
			}

			.user-activity-day {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.user-activity-date {
				font-weight: 600;
				color: var(--text-primary);
			}

			.user-activity-stats {
				display: flex;
				gap: 1rem;
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.pagination-controls {
				display: flex;
				justify-content: center;
				align-items: center;
				gap: 1rem;
				margin-top: 1rem;
				padding: 1rem;
				border-top: 1px solid var(--border-color);
			}

			.pagination-btn {
				background: var(--primary-color);
				color: white;
				border: none;
				padding: 0.5rem 1rem;
				border-radius: var(--border-radius-small);
				cursor: pointer;
				transition: var(--transition);
			}

			.pagination-btn:hover:not(:disabled) {
				background: var(--secondary-color);
			}

			.pagination-btn:disabled {
				background: var(--border-color);
				cursor: not-allowed;
			}

			.loading-spinner-small {
				display: inline-block;
				width: 20px;
				height: 20px;
				border: 2px solid var(--border-color);
				border-radius: 50%;
				border-top: 2px solid var(--primary-color);
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			/* Analysis Tab Styles */
			.analysis-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1rem;
			}

			.analysis-stat-card {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				text-align: center;
				position: relative;
				overflow: hidden;
			}

			.analysis-stat-card::before {
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 3px;
				background: linear-gradient(
					90deg,
					var(--primary-color),
					var(--secondary-color)
				);
			}

			.analysis-stat-value {
				font-size: 1.25rem;
				font-weight: bold;
				color: var(--primary-color);
				display: block;
				margin-bottom: 0.25rem;
			}

			.analysis-stat-label {
				font-size: 0.875rem;
				color: var(--text-muted);
			}

			.analysis-stat-sublabel {
				font-size: 0.75rem;
				color: var(--text-secondary);
				margin-top: 0.25rem;
			}

			.analysis-chart-container {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				position: relative;
				height: 250px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.behavioral-insights {
				display: grid;
				gap: 1rem;
			}

			.behavioral-insight-item {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.behavioral-insight-icon {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				background: linear-gradient(
					135deg,
					var(--primary-color),
					var(--secondary-color)
				);
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 1.2rem;
			}

			.behavioral-insight-content {
				flex: 1;
			}

			.behavioral-insight-title {
				font-weight: 600;
				color: var(--text-primary);
				margin-bottom: 0.25rem;
			}

			.behavioral-insight-description {
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.behavioral-insight-value {
				font-weight: bold;
				color: var(--primary-color);
			}

			.similar-users-detailed {
				display: grid;
				gap: 0.75rem;
			}

			.similar-user-item {
				background: var(--surface-dark);
				padding: 1rem;
				border-radius: var(--border-radius-small);
				border: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
				transition: var(--transition);
				cursor: pointer;
			}

			.similar-user-item:hover {
				background: var(--surface-hover);
				border-color: var(--primary-color);
			}

			.similar-user-info {
				display: flex;
				align-items: center;
				gap: 1rem;
			}

			.similar-user-avatar {
				width: 32px;
				height: 32px;
				border-radius: 50%;
				background: var(--primary-color);
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-weight: bold;
				font-size: 0.875rem;
			}

			.similar-user-details {
				display: flex;
				flex-direction: column;
			}

			.similar-user-name {
				font-weight: 600;
				color: var(--text-primary);
			}

			.similar-user-similarity {
				font-size: 0.875rem;
				color: var(--text-secondary);
			}

			.similar-user-actions {
				display: flex;
				gap: 0.5rem;
			}

			.similar-user-btn {
				background: var(--primary-color);
				color: white;
				border: none;
				padding: 0.25rem 0.5rem;
				border-radius: var(--border-radius-small);
				font-size: 0.75rem;
				cursor: pointer;
				transition: var(--transition);
			}

			.similar-user-btn:hover {
				background: var(--secondary-color);
			}

			.activity-intensity-bar {
				width: 100%;
				height: 6px;
				background: var(--border-color);
				border-radius: 3px;
				overflow: hidden;
				margin-top: 0.5rem;
			}

			.activity-intensity-fill {
				height: 100%;
				background: linear-gradient(
					90deg,
					var(--accent-color),
					var(--primary-color)
				);
				transition: width 0.3s ease;
			}
		</style>
	</head>
	<body>
		<div class="app-header">
			<h1><i class="fas fa-chart-line"></i> Chat Analytics Dashboard</h1>
		</div>

		<div class="status-bar">
			<div class="status-indicator">
				<div class="status-dot" id="connectionStatus"></div>
				<span id="connectionText">Connected</span>
			</div>
			<div id="lastUpdate">Last updated: Never</div>
		</div>

		<div class="container">
			<div class="controls-panel">
				<div class="controls-header">
					<i class="fas fa-filter"></i>
					<h3>Filters & Controls</h3>
				</div>
				<div class="controls-grid">
					<div class="form-group">
						<label for="channelSelect">Select Channel</label>
						<select
							id="channelSelect"
							class="modern-select"
							onchange="onChannelChange()"
						>
							<option value="">Choose a channel...</option>
						</select>
					</div>
					<div class="form-group">
						<label for="filterModeSelect">Filter Mode</label>
						<select
							id="filterModeSelect"
							class="modern-select"
							onchange="onFilterModeChange()"
						>
							<option value="range">Date Range</option>
							<option value="include">Select Specific Dates</option>
							<option value="exclude">Exclude Specific Dates</option>
						</select>
					</div>
					<div class="form-group" id="dateFilterGroup">
						<label for="dateFilterInput" id="dateFilterLabel"
							>Date Filter</label
						>
						<div class="date-picker-container">
							<input
								type="text"
								id="dateFilterInput"
								class="modern-input"
								placeholder="Select date or range..."
								onfocus="showDateSuggestions()"
								onblur="hideDateSuggestions()"
								oninput="filterDateSuggestions()"
							/>
							<div id="dateSuggestions" class="date-suggestions"></div>
						</div>
						<div
							id="selectedDatesContainer"
							class="selected-dates-container"
							style="display: none"
						>
							<div class="selected-dates-header">
								<span id="selectedDatesLabel">Selected Dates:</span>
								<button
									type="button"
									class="clear-dates-btn"
									onclick="clearSelectedDates()"
								>
									<i class="fas fa-times"></i> Clear All
								</button>
							</div>
							<div id="selectedDatesList" class="selected-dates-list"></div>
						</div>
					</div>
					<div class="form-group">
						<label>&nbsp;</label>
						<button class="modern-button" onclick="applyFilters()">
							<i class="fas fa-search"></i> Apply Filters
						</button>
					</div>
					<div class="form-group">
						<label>&nbsp;</label>
						<button class="modern-button secondary" onclick="clearFilters()">
							<i class="fas fa-times"></i> Clear All
						</button>
					</div>
				</div>
			</div>

			<div id="channelsOverview" class="channels-grid">
				<!-- Channel cards will be populated here -->
			</div>

			<div id="dataTableSection" class="data-section" style="display: none">
				<div class="section-header">
					<div class="section-title">
						<h2 id="sectionTitle">Channel Analytics</h2>
						<div id="channelSummary" class="summary-cards">
							<!-- Summary cards will be populated here -->
						</div>
					</div>
					<div class="table-controls">
						<div class="search-container">
							<i class="fas fa-search"></i>
							<input
								type="text"
								id="searchInput"
								class="modern-input"
								placeholder="Search users..."
								oninput="filterTable()"
							/>
						</div>
						<select
							id="sortSelect"
							class="modern-select"
							onchange="sortTable()"
						>
							<option value="chat_count">Sort by Messages</option>
							<option value="username">Sort by Username</option>
							<option value="alt_likelihood">Sort by Alt Score</option>
						</select>
					</div>
				</div>

				<div class="table-container">
					<div id="loadingSpinner" class="loading-state">
						<div class="spinner"></div>
						<p>Loading analytics data...</p>
					</div>

					<table id="dataTable" class="modern-table" style="display: none">
						<thead>
							<tr>
								<th onclick="sortByColumn('username')">
									<i class="fas fa-user"></i> Username
								</th>
								<th onclick="sortByColumn('chat_count')">
									<i class="fas fa-comments"></i> Messages
								</th>
								<th onclick="sortByColumn('alt_likelihood')">
									<i class="fas fa-shield-alt"></i> Alt Score
								</th>
								<th><i class="fas fa-chart-line"></i> Last Active</th>
							</tr>
						</thead>
						<tbody id="tableBody">
							<!-- Table rows will be populated here -->
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- User Detail Popup -->
		<div id="userDetailOverlay" class="user-detail-overlay">
			<div class="user-detail-popup">
				<div class="user-detail-header">
					<div class="user-detail-title">
						<div class="user-avatar" id="userAvatar"></div>
						<div>
							<h2 id="userDetailName">Username</h2>
							<p id="userDetailSubtitle" style="opacity: 0.8; margin: 0"></p>
						</div>
					</div>
					<button class="user-detail-close" onclick="closeUserDetail()" aria-label="Close user details">
						<i class="fas fa-times"></i>
					</button>
				</div>
				<div class="user-detail-content">
					<div class="user-detail-tabs">
						<button
							class="user-detail-tab active"
							onclick="switchUserTab('overview')"
						>
							<i class="fas fa-chart-bar"></i> Overview
						</button>
						<button class="user-detail-tab" onclick="switchUserTab('messages')">
							<i class="fas fa-comments"></i> Messages
						</button>
						<button class="user-detail-tab" onclick="switchUserTab('channels')">
							<i class="fas fa-hashtag"></i> Channels
						</button>
						<button class="user-detail-tab" onclick="switchUserTab('analysis')">
							<i class="fas fa-analytics"></i> Analysis
						</button>
						<button class="user-detail-tab" onclick="switchUserTab('activity')">
							<i class="fas fa-calendar-alt"></i> Activity
						</button>
					</div>

					<!-- Overview Tab -->
					<div id="overviewTab" class="user-detail-tab-content active">
						<div class="user-stats-grid" id="userStatsGrid">
							<!-- Stats will be populated here -->
						</div>
						<div>
							<h4 style="margin-bottom: 1rem; color: var(--text-primary)">
								<i class="fas fa-users"></i> Similar Users
							</h4>
							<div id="userSimilarUsers" style="color: var(--text-secondary)">
								<!-- Similar users will be populated here -->
							</div>
						</div>
					</div>

					<!-- Messages Tab -->
					<div id="messagesTab" class="user-detail-tab-content">
						<div
							style="
								margin-bottom: 1rem;
								display: flex;
								gap: 1rem;
								align-items: center;
							"
						>
							<label style="color: var(--text-secondary)"
								>Filter messages:</label
							>
							<input
								type="text"
								id="messageSearch"
								placeholder="Search messages..."
								class="modern-input"
								style="flex: 1"
								oninput="filterUserMessages()"
							/>
							<button
								class="modern-button secondary"
								onclick="clearMessageFilter()"
							>
								<i class="fas fa-times"></i> Clear
							</button>
						</div>
						<div id="userMessagesContainer">
							<div class="user-messages-list" id="userMessagesList">
								<!-- Messages will be populated here -->
							</div>
							<div class="pagination-controls" id="messagesPagination">
								<!-- Pagination will be populated here -->
							</div>
						</div>
					</div>

					<!-- Channels Tab -->
					<div id="channelsTab" class="user-detail-tab-content">
						<div class="user-channels-list" id="userChannelsList">
							<!-- Channels will be populated here -->
						</div>
					</div>

					<!-- Analysis Tab -->
					<div id="analysisTab" class="user-detail-tab-content">
						<div style="display: grid; gap: 2rem">
							<!-- Temporal Analysis Section -->
							<div>
								<h4
									style="
										margin-bottom: 1rem;
										color: var(--text-primary);
										display: flex;
										align-items: center;
										gap: 0.5rem;
									"
								>
									<i class="fas fa-clock"></i> Temporal Analysis
								</h4>
								<div class="analysis-grid" id="temporalAnalysisGrid">
									<!-- Temporal stats will be populated here -->
								</div>
							</div>

							<!-- Chat Frequency Patterns -->
							<div>
								<h4
									style="
										margin-bottom: 1rem;
										color: var(--text-primary);
										display: flex;
										align-items: center;
										gap: 0.5rem;
									"
								>
									<i class="fas fa-chart-line"></i> Chat Frequency Patterns
								</h4>
								<div class="analysis-chart-container">
									<canvas
										id="hourlyActivityChart"
										width="400"
										height="200"
									></canvas>
								</div>
							</div>

							<!-- Behavioral Insights -->
							<div>
								<h4
									style="
										margin-bottom: 1rem;
										color: var(--text-primary);
										display: flex;
										align-items: center;
										gap: 0.5rem;
									"
								>
									<i class="fas fa-brain"></i> Behavioral Insights
								</h4>
								<div class="behavioral-insights" id="behavioralInsights">
									<!-- Behavioral analysis will be populated here -->
								</div>
							</div>

							<!-- Similar Users (moved from table) -->
							<div>
								<h4
									style="
										margin-bottom: 1rem;
										color: var(--text-primary);
										display: flex;
										align-items: center;
										gap: 0.5rem;
									"
								>
									<i class="fas fa-users"></i> Similar Users
								</h4>
								<div id="detailedSimilarUsers" class="similar-users-detailed">
									<!-- Detailed similar users will be populated here -->
								</div>
							</div>
						</div>
					</div>

					<!-- Activity Tab -->
					<div id="activityTab" class="user-detail-tab-content">
						<div class="user-activity-timeline" id="userActivityTimeline">
							<!-- Activity timeline will be populated here -->
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			// WebSocket connection and global state
			const socket = io();
			let allChannelsData = [];
			let currentChannelData = null;
			let selectedChannel = null;
			let currentDateFilter = null;
			let availableDates = [];
			let sortDirection = {};

			// Enhanced date filtering state
			let filterMode = "range"; // 'range', 'include', 'exclude'
			let selectedDates = new Set();
			let excludedDates = new Set();

			// DOM elements
			const statusDot = document.getElementById("connectionStatus");
			const statusText = document.getElementById("connectionText");
			const lastUpdateElement = document.getElementById("lastUpdate");
			const channelSelect = document.getElementById("channelSelect");
			const dateFilterInput = document.getElementById("dateFilterInput");
			const dateSuggestions = document.getElementById("dateSuggestions");

			// Enhanced Date Filter Functions
			function onFilterModeChange() {
				const modeSelect = document.getElementById("filterModeSelect");
				const dateFilterLabel = document.getElementById("dateFilterLabel");
				const selectedDatesContainer = document.getElementById(
					"selectedDatesContainer"
				);
				const selectedDatesLabel =
					document.getElementById("selectedDatesLabel");

				filterMode = modeSelect.value;

				// Clear previous selections
				selectedDates.clear();
				excludedDates.clear();
				updateSelectedDatesDisplay();

				// Update UI based on mode
				switch (filterMode) {
					case "range":
						dateFilterLabel.textContent = "Date Range";
						dateFilterInput.placeholder = "2024-01-01 or 2024-01-01:2024-01-31";
						selectedDatesContainer.style.display = "none";
						dateFilterInput.style.display = "block";
						break;
					case "include":
						dateFilterLabel.textContent = "Select Dates to Include";
						dateFilterInput.placeholder = "Search for dates to include...";
						selectedDatesContainer.style.display = "block";
						selectedDatesLabel.textContent = "Selected Dates:";
						dateFilterInput.style.display = "block";
						break;
					case "exclude":
						dateFilterLabel.textContent = "Select Dates to Exclude";
						dateFilterInput.placeholder = "Search for dates to exclude...";
						selectedDatesContainer.style.display = "block";
						selectedDatesLabel.textContent = "Excluded Dates:";
						dateFilterInput.style.display = "block";
						break;
				}

				// Add help text
				addFilterModeHelp();
				updateDateSuggestions();
			}

			function addFilterModeHelp() {
				// Remove existing help text
				const existingHelp = document.querySelector(".filter-mode-help");
				if (existingHelp) {
					existingHelp.remove();
				}

				const dateFilterGroup = document.getElementById("dateFilterGroup");
				const helpDiv = document.createElement("div");
				helpDiv.className = "filter-mode-help";

				switch (filterMode) {
					case "range":
						helpDiv.innerHTML =
							'<i class="fas fa-info-circle"></i> Enter a single date (2024-01-01) or range (2024-01-01:2024-01-31)';
						break;
					case "include":
						helpDiv.innerHTML =
							'<i class="fas fa-info-circle"></i> Click dates below to include only those dates in the analysis';
						break;
					case "exclude":
						helpDiv.innerHTML =
							'<i class="fas fa-info-circle"></i> Click dates below to exclude them from the analysis (all others included)';
						break;
				}

				dateFilterGroup.appendChild(helpDiv);
			}

			function clearSelectedDates() {
				selectedDates.clear();
				excludedDates.clear();
				updateSelectedDatesDisplay();
				updateDateSuggestions();
			}

			function updateSelectedDatesDisplay() {
				const selectedDatesList = document.getElementById("selectedDatesList");
				const currentSet =
					filterMode === "exclude" ? excludedDates : selectedDates;

				selectedDatesList.innerHTML = "";

				if (currentSet.size === 0) {
					selectedDatesList.innerHTML =
						'<span style="color: var(--text-muted); font-style: italic;">None selected</span>';
					return;
				}

				const sortedDates = Array.from(currentSet).sort();
				sortedDates.forEach((date) => {
					const chip = document.createElement("div");
					chip.className = `selected-date-chip ${
						filterMode === "exclude" ? "exclude-mode" : ""
					}`;
					chip.innerHTML = `
						<span>${date}</span>
						<button class="remove-btn" onclick="removeSelectedDate('${date}')" type="button">
							<i class="fas fa-times"></i>
						</button>
					`;
					selectedDatesList.appendChild(chip);
				});
			}

			function removeSelectedDate(date) {
				if (filterMode === "exclude") {
					excludedDates.delete(date);
				} else {
					selectedDates.delete(date);
				}
				updateSelectedDatesDisplay();
				updateDateSuggestions();
			}

			function toggleDateSelection(date, event) {
				event.preventDefault();
				event.stopPropagation();

				if (filterMode === "range") {
					// For range mode, set the input value
					dateFilterInput.value = date;
					hideDateSuggestions();
					return;
				}

				const currentSet =
					filterMode === "exclude" ? excludedDates : selectedDates;

				if (currentSet.has(date)) {
					currentSet.delete(date);
				} else {
					currentSet.add(date);
				}

				updateSelectedDatesDisplay();
				updateDateSuggestions();

				// Keep suggestions open for multi-select modes
				setTimeout(showDateSuggestions, 10);
			}

			function buildDateFilterString() {
				switch (filterMode) {
					case "range":
						return dateFilterInput.value.trim() || null;
					case "include":
						if (selectedDates.size === 0) return null;
						return `include:${Array.from(selectedDates).sort().join(",")}`;
					case "exclude":
						if (excludedDates.size === 0) return null;
						return `exclude:${Array.from(excludedDates).sort().join(",")}`;
					default:
						return null;
				}
			}

			// Socket event handlers
			socket.on("connect", function () {
				statusDot.classList.remove("disconnected");
				statusText.textContent = "Connected";
				console.log("Connected to server");
			});

			socket.on("disconnect", function () {
				statusDot.classList.add("disconnected");
				statusText.textContent = "Disconnected";
				console.log("Disconnected from server");
			});

			socket.on("data_update", function (data) {
				console.log("Data update received:", data);
				allChannelsData = data.channels;
				updateChannelsOverview();
				updateLastUpdateTime();

				if (selectedChannel) {
					requestChannelData(selectedChannel, currentDateFilter);
				}
			});

			socket.on("channel_data", function (data) {
				console.log("Channel data received:", data);
				currentChannelData = data;
				displayChannelData(data);
			});

			socket.on("error", function (data) {
				console.error("Socket error:", data);
				showNotification("Error: " + data.message, "error");
			});

			// Load channels on page load
			document.addEventListener("DOMContentLoaded", function () {
				loadChannels();
			});

			async function loadChannels() {
				try {
					const response = await fetch("/api/summary");
					const data = await response.json();
					allChannelsData = data.channels;
					updateChannelsOverview();
					populateChannelSelect();
				} catch (error) {
					console.error("Error loading channels:", error);
					showNotification("Failed to load channels", "error");
				}
			}

			function populateChannelSelect() {
				channelSelect.innerHTML =
					'<option value="">Choose a channel...</option>';
				allChannelsData.forEach((channel) => {
					const option = document.createElement("option");
					option.value = channel.channel;
					option.textContent = channel.channel;
					channelSelect.appendChild(option);
				});
			}

			function updateChannelsOverview() {
				const container = document.getElementById("channelsOverview");
				container.innerHTML = "";

				allChannelsData.forEach((channel) => {
					const card = createChannelCard(channel);
					container.appendChild(card);
				});
			}

			function createChannelCard(channel) {
				const card = document.createElement("div");
				card.className = "channel-card";
				if (selectedChannel === channel.channel) {
					card.classList.add("selected");
				}

				const channelInitial = channel.channel.charAt(0).toUpperCase();

				card.innerHTML = `
                <div class="channel-header">
                    <div class="channel-icon">${channelInitial}</div>
                    <div class="channel-name">${channel.channel}</div>
                </div>
                <div class="channel-stats">
                    <div class="stat-item">
                        <span class="stat-value">${channel.total_users.toLocaleString()}</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${channel.unique_user_count.toLocaleString()}</span>
                        <span class="stat-label">Unique Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${channel.total_messages.toLocaleString()}</span>
                        <span class="stat-label">Messages</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${channel.start_date}</span>
                        <span class="stat-label">to ${channel.end_date}</span>
                    </div>
                </div>
            `;

				card.onclick = () => selectChannel(channel.channel);
				return card;
			}

			async function selectChannel(channelName) {
				selectedChannel = channelName;
				channelSelect.value = channelName;
				updateChannelsOverview();

				// Load available dates for this channel
				await loadAvailableDates(channelName);

				// Request channel data
				requestChannelData(channelName, currentDateFilter);
			}

			async function loadAvailableDates(channelName) {
				try {
					const response = await fetch(`/api/channel/${channelName}/dates`);
					const data = await response.json();
					availableDates = data.dates;
					updateDateSuggestions();
				} catch (error) {
					console.error("Error loading dates:", error);
				}
			}

			function onChannelChange() {
				const channelName = channelSelect.value;
				if (channelName) {
					selectChannel(channelName);
				} else {
					selectedChannel = null;
					currentDateFilter = null;
					dateFilterInput.value = "";
					document.getElementById("dataTableSection").style.display = "none";
					updateChannelsOverview();
				}
			}

			function requestChannelData(channelName, dateFilter = null) {
				document.getElementById("loadingSpinner").style.display = "block";
				document.getElementById("dataTable").style.display = "none";
				document.getElementById("dataTableSection").style.display = "block";

				socket.emit("request_channel_data", {
					channel: channelName,
					date_filter: dateFilter,
				});
			}

			function displayChannelData(data) {
				document.getElementById("loadingSpinner").style.display = "none";
				document.getElementById("dataTable").style.display = "table";

				// Update section title
				document.getElementById(
					"sectionTitle"
				).textContent = `${data.channel} Analytics`;

				// Update summary cards
				const summaryContainer = document.getElementById("channelSummary");
				summaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="stat-value">${data.total_users.toLocaleString()}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="summary-card">
                    <div class="stat-value">${data.unique_user_count.toLocaleString()}</div>
                    <div class="stat-label">Unique Users</div>
                </div>
                <div class="summary-card">
                    <div class="stat-value">${data.total_messages.toLocaleString()}</div>
                    <div class="stat-label">Messages</div>
                </div>
                <div class="summary-card">
                    <div class="stat-value">${data.start_date}</div>
                    <div class="stat-label">to ${data.end_date}</div>
                </div>
            `;

				// Populate table
				const tbody = document.getElementById("tableBody");
				tbody.innerHTML = "";

				data.user_stats.forEach((user) => {
					const row = document.createElement("tr");

					// Determine alt likelihood class
					let altClass = "low";
					if (user.alt_likelihood > 70) altClass = "high";
					else if (user.alt_likelihood > 40) altClass = "medium";

					// Format last updated time
					const lastActive = new Date(user.last_updated).toLocaleString();

					row.innerHTML = `
                    <td><strong><a href="#" onclick="openUserDetail('${user.username.replace(
											/'/g,
											"\\'"
										)}'); return false;" style="color: var(--primary-color); text-decoration: none; cursor: pointer; transition: var(--transition);" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${
						user.username
					}</a></strong></td>
                    <td>${user.chat_count.toLocaleString()}</td>
                    <td><span class="alt-badge ${altClass}">${user.alt_likelihood.toFixed(
						1
					)}%</span></td>
                    <td><span style="color: var(--text-secondary); font-size: 0.875rem;">${lastActive}</span></td>
                `;

					tbody.appendChild(row);
				});
			}

			function showDateSuggestions() {
				if (availableDates.length > 0) {
					updateDateSuggestions();
					dateSuggestions.style.display = "block";
				}
			}

			function hideDateSuggestions() {
				setTimeout(() => {
					dateSuggestions.style.display = "none";
				}, 200);
			}

			function updateDateSuggestions() {
				if (!availableDates.length) return;

				const filter = dateFilterInput.value.toLowerCase();
				const filteredDates = availableDates.filter((date) =>
					date.toLowerCase().includes(filter)
				);

				dateSuggestions.innerHTML = "";

				// Add individual dates
				filteredDates.forEach((date) => {
					const suggestion = document.createElement("div");
					suggestion.className = "date-suggestion";
					suggestion.textContent = date;
					suggestion.onclick = () => selectDate(date);
					dateSuggestions.appendChild(suggestion);
				});

				// Add range suggestions
				if (filteredDates.length >= 2 && !filter) {
					const firstDate = filteredDates[0];
					const lastDate = filteredDates[filteredDates.length - 1];

					const rangeSuggestion = document.createElement("div");
					rangeSuggestion.className = "date-suggestion";
					rangeSuggestion.innerHTML = `<strong>Full Range:</strong> ${firstDate} to ${lastDate}`;
					rangeSuggestion.onclick = () =>
						selectDate(`${firstDate}:${lastDate}`);
					dateSuggestions.appendChild(rangeSuggestion);
				}
			}

			function filterDateSuggestions() {
				updateDateSuggestions();
			}

			function selectDate(dateValue) {
				dateFilterInput.value = dateValue;
				dateSuggestions.style.display = "none";
			}

			function applyFilters() {
				const channel = channelSelect.value;

				if (!channel) {
					showNotification("Please select a channel first", "error");
					return;
				}

				// Build the date filter string based on current mode
				const dateFilter = buildDateFilterString();
				currentDateFilter = dateFilter;

				// Show user-friendly feedback
				if (dateFilter) {
					let message = "Applying filter: ";
					if (filterMode === "range") {
						message += `Date range ${dateFilter}`;
					} else if (filterMode === "include") {
						const dateCount = selectedDates.size;
						message += `${dateCount} selected date${
							dateCount !== 1 ? "s" : ""
						}`;
					} else if (filterMode === "exclude") {
						const dateCount = excludedDates.size;
						message += `Excluding ${dateCount} date${
							dateCount !== 1 ? "s" : ""
						}`;
					}
					showNotification(message, "success");
				}

				requestChannelData(channel, currentDateFilter);
			}

			function clearFilters() {
				dateFilterInput.value = "";
				selectedDates.clear();
				excludedDates.clear();
				updateSelectedDatesDisplay();
				currentDateFilter = null;

				if (selectedChannel) {
					requestChannelData(selectedChannel, null);
					showNotification("Filters cleared", "success");
				}
			}

			// Add missing functions for the new enhanced system
			function showDateSuggestions() {
				if (availableDates.length > 0) {
					updateDateSuggestions();
					dateSuggestions.style.display = "block";
				}
			}

			function hideDateSuggestions() {
				// Delay hiding to allow for clicks
				setTimeout(() => {
					dateSuggestions.style.display = "none";
				}, 150);
			}

			function filterDateSuggestions() {
				updateDateSuggestions();
			}

			// User Detail Popup Functionality
			let currentUserData = null;
			let currentMessagesPage = 1;
			let userMessageCache = {};

			function openUserDetail(username) {
				if (!selectedChannel) {
					showNotification("Please select a channel first", "error");
					return;
				}

				// Show popup immediately with loading state
				document.getElementById("userDetailOverlay").style.display = "flex";
				document.getElementById("userDetailName").textContent = username;
				document.getElementById("userDetailSubtitle").textContent =
					"Loading...";
				document.getElementById("userAvatar").textContent = username
					.charAt(0)
					.toUpperCase();

				// Reset to overview tab
				switchUserTab("overview");
				currentMessagesPage = 1;

				// Load user details
				loadUserDetails(username);
			}

			async function loadUserDetails(username) {
				try {
					const currentFilter = buildDateFilterString();
					const params = new URLSearchParams({
						channel: selectedChannel,
						page: 1,
						limit: 100,
					});

					if (currentFilter) {
						params.append("date_filter", currentFilter);
					}

					const response = await fetch(
						`/api/user/${encodeURIComponent(username)}?${params}`
					);
					const data = await response.json();

					if (data.error) {
						showNotification(data.error, "error");
						closeUserDetail();
						return;
					}

					currentUserData = data;
					populateUserDetail(data);
				} catch (error) {
					console.error("Error loading user details:", error);
					showNotification("Failed to load user details", "error");
					closeUserDetail();
				}
			}

			function populateUserDetail(data) {
				// Update header
				document.getElementById("userDetailName").textContent = data.username;
				document.getElementById(
					"userDetailSubtitle"
				).textContent = `${data.stats.chat_count} messages in ${selectedChannel}`;

				// Populate overview tab
				populateOverviewTab(data);

				// Populate messages tab
				populateMessagesTab(data);

				// Populate channels tab
				populateChannelsTab(data);

				// Populate activity tab
				populateActivityTab(data);
			}

			function populateOverviewTab(data) {
				const statsGrid = document.getElementById("userStatsGrid");

				const altBadgeClass =
					data.stats.alt_likelihood < 30
						? "low"
						: data.stats.alt_likelihood < 70
						? "medium"
						: "high";

				statsGrid.innerHTML = `
					<div class="user-stat-card">
						<span class="user-stat-value">${data.stats.chat_count.toLocaleString()}</span>
						<div class="user-stat-label">Total Messages</div>
					</div>
					<div class="user-stat-card">
						<span class="user-stat-value alt-badge ${altBadgeClass}">${data.stats.alt_likelihood.toFixed(
					1
				)}%</span>
						<div class="user-stat-label">Alt Likelihood</div>
					</div>
					<div class="user-stat-card">
						<span class="user-stat-value">${data.channels.length}</span>
						<div class="user-stat-label">Active Channels</div>
					</div>
					<div class="user-stat-card">
						<span class="user-stat-value">${data.activity_timeline.length}</span>
						<div class="user-stat-label">Active Days</div>
					</div>
				`;

				const similarUsersDiv = document.getElementById("userSimilarUsers");
				if (data.stats.similar_users && data.stats.similar_users.length > 0) {
					similarUsersDiv.innerHTML = data.stats.similar_users.join(", ");
				} else {
					similarUsersDiv.innerHTML = "<em>No similar users detected</em>";
				}
			}

			function populateMessagesTab(data) {
				const messagesList = document.getElementById("userMessagesList");

				if (data.messages.length === 0) {
					messagesList.innerHTML =
						'<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No messages found</div>';
					return;
				}

				messagesList.innerHTML = data.messages
					.map((msg) => {
						const timestamp = new Date(msg.timestamp);
						const dateStr = msg.log_date;
						const timeStr = timestamp.toLocaleTimeString();

						return `
						<div class="user-message-item">
							<div class="user-message-meta">
								<span class="user-message-date">${dateStr}</span>
								<span class="user-message-time">${timeStr}</span>
							</div>
							<div class="user-message-text">${escapeHtml(msg.message)}</div>
						</div>
					`;
					})
					.join("");

				// Update pagination
				const pagination = document.getElementById("messagesPagination");
				const hasMore = data.pagination.has_more;
				const currentPage = data.pagination.page;

				pagination.innerHTML = `
					<button class="pagination-btn" ${currentPage <= 1 ? "disabled" : ""} 
							onclick="loadUserMessagesPage(${currentPage - 1})">
						<i class="fas fa-chevron-left"></i> Previous
					</button>
					<span>Page ${currentPage}</span>
					<button class="pagination-btn" ${!hasMore ? "disabled" : ""} 
							onclick="loadUserMessagesPage(${currentPage + 1})">
						Next <i class="fas fa-chevron-right"></i>
					</button>
				`;
			}

			function populateChannelsTab(data) {
				const channelsList = document.getElementById("userChannelsList");

				if (data.channels.length === 0) {
					channelsList.innerHTML =
						'<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No channel activity found</div>';
					return;
				}

				channelsList.innerHTML = data.channels
					.map(
						(channel) => `
					<div class="user-channel-item">
						<div>
							<div class="user-channel-name">#${channel.channel}</div>
							<div class="user-channel-stats">
								${channel.message_count.toLocaleString()} messages • 
								${channel.first_message_date} to ${channel.last_message_date}
							</div>
						</div>
						<div style="text-align: right;">
							<div style="font-weight: 600; color: var(--text-primary);">
								${channel.message_count.toLocaleString()}
							</div>
							<div style="font-size: 0.75rem; color: var(--text-muted);">messages</div>
						</div>
					</div>
				`
					)
					.join("");
			}

			function populateActivityTab(data) {
				const timeline = document.getElementById("userActivityTimeline");

				if (data.activity_timeline.length === 0) {
					timeline.innerHTML =
						'<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No activity data found</div>';
					return;
				}

				timeline.innerHTML = data.activity_timeline
					.map((day) => {
						const firstTime = new Date(
							day.first_message_time
						).toLocaleTimeString();
						const lastTime = new Date(
							day.last_message_time
						).toLocaleTimeString();

						return `
						<div class="user-activity-day">
							<div class="user-activity-date">${day.date}</div>
							<div class="user-activity-stats">
								<span><i class="fas fa-comments"></i> ${day.message_count}</span>
								<span><i class="fas fa-clock"></i> ${firstTime} - ${lastTime}</span>
								<span><i class="fas fa-chart-line"></i> ${day.active_hours}h active</span>
							</div>
						</div>
					`;
					})
					.join("");
			}

			async function loadUserMessagesPage(page) {
				if (!currentUserData) return;

				currentMessagesPage = page;
				const messagesList = document.getElementById("userMessagesList");
				messagesList.innerHTML =
					'<div style="text-align: center; padding: 2rem;"><div class="loading-spinner-small"></div> Loading messages...</div>';

				try {
					const currentFilter = buildDateFilterString();
					const params = new URLSearchParams({
						channel: selectedChannel,
						page: page,
						limit: 100,
					});

					if (currentFilter) {
						params.append("date_filter", currentFilter);
					}

					const response = await fetch(
						`/api/user/${encodeURIComponent(
							currentUserData.username
						)}?${params}`
					);
					const data = await response.json();

					if (data.error) {
						showNotification(data.error, "error");
						return;
					}

					// Update only the messages part
					currentUserData.messages = data.messages;
					currentUserData.pagination = data.pagination;
					populateMessagesTab(currentUserData);
				} catch (error) {
					console.error("Error loading messages page:", error);
					showNotification("Failed to load messages", "error");
				}
			}

			function switchUserTab(tabName) {
				// Remove active class from all tabs and contents
				document
					.querySelectorAll(".user-detail-tab")
					.forEach((tab) => tab.classList.remove("active"));
				document
					.querySelectorAll(".user-detail-tab-content")
					.forEach((content) => content.classList.remove("active"));

				// Add active class to selected tab and content
				event.target.classList.add("active");
				document.getElementById(tabName + "Tab").classList.add("active");
			}

			function closeUserDetail() {
				document.getElementById("userDetailOverlay").style.display = "none";
				currentUserData = null;
				currentMessagesPage = 1;
			}

			function filterUserMessages() {
				const searchTerm = document
					.getElementById("messageSearch")
					.value.toLowerCase();
				const messageItems = document.querySelectorAll(".user-message-item");

				messageItems.forEach((item) => {
					const messageText = item
						.querySelector(".user-message-text")
						.textContent.toLowerCase();
					if (messageText.includes(searchTerm)) {
						item.style.display = "block";
					} else {
						item.style.display = "none";
					}
				});
			}

			function clearMessageFilter() {
				document.getElementById("messageSearch").value = "";
				filterUserMessages();
			}

			function escapeHtml(text) {
				const div = document.createElement("div");
				div.textContent = text;
				return div.innerHTML;
			}

			// Close popup when clicking outside
			document
				.getElementById("userDetailOverlay")
				.addEventListener("click", function (e) {
					if (e.target === this) {
						closeUserDetail();
					}
				});

			// Close popup with Escape key
			document.addEventListener("keydown", function (e) {
				if (
					e.key === "Escape" &&
					document.getElementById("userDetailOverlay").style.display === "flex"
				) {
					closeUserDetail();
				}
			});

			function filterTable() {
				const searchTerm = document
					.getElementById("searchInput")
					.value.toLowerCase();
				const table = document.getElementById("dataTable");
				const rows = table.getElementsByTagName("tr");

				for (let i = 1; i < rows.length; i++) {
					const username = rows[i].cells[0].textContent.toLowerCase();
					const visible = username.includes(searchTerm);
					rows[i].style.display = visible ? "" : "none";
				}
			}

			function sortTable() {
				const sortBy = document.getElementById("sortSelect").value;
				if (!currentChannelData) return;

				let sortedData = [...currentChannelData.user_stats];

				sortedData.sort((a, b) => {
					if (sortBy === "username") {
						return a.username.localeCompare(b.username);
					} else {
						return b[sortBy] - a[sortBy];
					}
				});

				currentChannelData.user_stats = sortedData;
				displayChannelData(currentChannelData);
			}

			function sortByColumn(column) {
				const isAscending = sortDirection[column] || false;
				sortDirection[column] = !isAscending;

				if (!currentChannelData) return;

				let sortedData = [...currentChannelData.user_stats];

				sortedData.sort((a, b) => {
					let aVal = a[column];
					let bVal = b[column];

					if (column === "username") {
						return isAscending
							? aVal.localeCompare(bVal)
							: bVal.localeCompare(aVal);
					} else {
						return isAscending ? aVal - bVal : bVal - aVal;
					}
				});

				currentChannelData.user_stats = sortedData;
				displayChannelData(currentChannelData);
			}

			function updateLastUpdateTime() {
				const now = new Date();
				lastUpdateElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
			}

			function showNotification(message, type = "success") {
				const notification = document.createElement("div");
				notification.className = `notification ${type}`;
				notification.textContent = message;
				document.body.appendChild(notification);

				setTimeout(() => notification.classList.add("show"), 100);
				setTimeout(() => {
					notification.classList.remove("show");
					setTimeout(() => notification.remove(), 300);
				}, 3000);
			}
			// User Detail Analysis Functions
			async function loadUserAnalysis(username) {
				try {
					const channel = selectedChannel;
					const dateFilter = buildDateFilterString();
					
					// Fetch temporal analysis
					const temporalResponse = await fetch(`/api/user/${username}/temporal_analysis?channel=${channel}&date_filter=${dateFilter || ''}`);
					const temporalData = await temporalResponse.json();
					
					// Fetch behavioral insights
					const behavioralResponse = await fetch(`/api/user/${username}/behavioral_insights?channel=${channel}&date_filter=${dateFilter || ''}`);
					const behavioralData = await behavioralResponse.json();
					
					// Populate temporal analysis
					populateTemporalAnalysis(temporalData);
					
					// Populate behavioral insights
					populateBehavioralInsights(behavioralData);
					
					// Create hourly activity chart
					createHourlyActivityChart(temporalData.hourly_distribution || {});
					
				} catch (error) {
					console.error('Error loading user analysis:', error);
					showNotification('Error loading analysis data', 'error');
				}
			}
			
			function populateTemporalAnalysis(data) {
				const grid = document.getElementById('temporalAnalysisGrid');
				grid.innerHTML = '';
				
				const stats = [
					{
						value: data.avg_messages_per_day || 0,
						label: 'Messages Per Day',
						sublabel: 'Average daily activity'
					},
					{
						value: data.avg_messages_per_hour || 0,
						label: 'Messages Per Hour',
						sublabel: 'When active'
					},
					{
						value: data.avg_session_length_hours || 0,
						label: 'Session Length',
						sublabel: 'Hours per session'
					},
					{
						value: data.peak_activity_hour || '12',
						label: 'Peak Hour',
						sublabel: `${data.peak_hour_messages || 0} messages`
					},
					{
						value: data.active_days || 0,
						label: 'Active Days',
						sublabel: 'Total days with activity'
					},
					{
						value: (data.consistency_score * 100).toFixed(1) + '%',
						label: 'Consistency Score',
						sublabel: 'How regular is activity'
					}
				];
				
				stats.forEach(stat => {
					const card = document.createElement('div');
					card.className = 'analysis-stat-card';
					card.innerHTML = `
						<span class="analysis-stat-value">${stat.value}</span>
						<div class="analysis-stat-label">${stat.label}</div>
						<div class="analysis-stat-sublabel">${stat.sublabel}</div>
					`;
					grid.appendChild(card);
				});
			}
			
			function populateBehavioralInsights(data) {
				const container = document.getElementById('behavioralInsights');
				container.innerHTML = '';
				
				const insights = [
					{
						icon: 'fas fa-clock',
						title: 'Message Frequency',
						description: `${data.message_frequency?.per_minute?.toFixed(3) || 0} messages per minute, ${data.message_frequency?.per_hour?.toFixed(1) || 0} per hour`
					},
					{
						icon: 'fas fa-chart-bar',
						title: 'Engagement Level',
						description: `${data.engagement_level || 'Unknown'} engagement with ${data.burst_messaging ? 'burst' : 'steady'} messaging pattern`
					},
					{
						icon: 'fas fa-edit',
						title: 'Writing Style',
						description: `Avg ${data.writing_style?.avg_message_length?.toFixed(1) || 0} chars per message, ${(data.writing_style?.question_frequency * 100)?.toFixed(1) || 0}% questions`
					},
					{
						icon: 'fas fa-chart-line',
						title: 'Activity Consistency',
						description: `${(data.activity_consistency * 100)?.toFixed(1) || 0}% consistency score across active days`
					}
				];
				
				// Add activity patterns if available
				if (data.activity_patterns && data.activity_patterns.length > 0) {
					data.activity_patterns.forEach(pattern => {
						insights.push({
							icon: 'fas fa-analytics',
							title: pattern.pattern,
							description: pattern.description
						});
					});
				}
				
				insights.forEach(insight => {
					const item = document.createElement('div');
					item.className = 'behavioral-insight-item';
					item.innerHTML = `
						<div class="behavioral-insight-icon">
							<i class="${insight.icon}"></i>
						</div>
						<div class="behavioral-insight-content">
							<div class="behavioral-insight-title">${insight.title}</div>
							<div class="behavioral-insight-description">${insight.description}</div>
						</div>
					`;
					container.appendChild(item);
				});
			}
			
			function createHourlyActivityChart(hourlyData) {
				const canvas = document.getElementById('hourlyActivityChart');
				const ctx = canvas.getContext('2d');
				
				// Destroy existing chart if it exists
				if (window.hourlyChart) {
					window.hourlyChart.destroy();
				}
				
				// Prepare data for 24-hour chart
				const hours = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));
				const data = hours.map(hour => hourlyData[hour] || 0);
				
				window.hourlyChart = new Chart(ctx, {
					type: 'bar',
					data: {
						labels: hours.map(h => h + ':00'),
						datasets: [{
							label: 'Messages',
							data: data,
							backgroundColor: 'rgba(102, 126, 234, 0.6)',
							borderColor: 'rgba(102, 126, 234, 1)',
							borderWidth: 1
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: {
								display: false
							}
						},
						scales: {
							y: {
								beginAtZero: true,
								ticks: {
									color: '#cccccc'
								},
								grid: {
									color: '#444444'
								}
							},
							x: {
								ticks: {
									color: '#cccccc',
									maxRotation: 45
								},
								grid: {
									color: '#444444'
								}
							}
						}
					}
				});
			}
			
			function populateDetailedSimilarUsers(similarUsers) {
				const container = document.getElementById('detailedSimilarUsers');
				container.innerHTML = '';
				
				if (!similarUsers || similarUsers.length === 0) {
					container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No similar users found</p>';
					return;
				}
				
				similarUsers.forEach(user => {
					const item = document.createElement('div');
					item.className = 'similar-user-item';
					item.onclick = () => openUserDetail(user.username);
					
					const avatar = user.username.charAt(0).toUpperCase();
					const similarity = typeof user.similarity === 'number' ? 
						`${(user.similarity * 100).toFixed(1)}% similar` : 
						user.similarity || 'Similar user';
					
					item.innerHTML = `
						<div class="similar-user-info">
							<div class="similar-user-avatar">${avatar}</div>
							<div class="similar-user-details">
								<div class="similar-user-name">${user.username}</div>
								<div class="similar-user-similarity">${similarity}</div>
							</div>
						</div>
						<div class="similar-user-actions">
							<button class="similar-user-btn" onclick="event.stopPropagation(); openUserDetail('${user.username}')">
								View Details
							</button>
						</div>
					`;
					container.appendChild(item);
				});
			}

		</script>
	</body>
</html>
